name: PSR Draft release
run-name: PSR Draft release ${{ inputs.next_version }}
on:
  push:
    branches:
      - main

# Default permissions (least privilege)
permissions:
  contents: read
  

jobs:
  release:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    permissions:
      contents: write
      id-token: write

    outputs:
      released: ${{ steps.release.outputs.released }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      # Required to forward SSH key to PSR Docker image
      - name: Setup SSH Agent with Deploy Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Configure git
        run: |
          git config --local user.email "github-actions@github.com"
          git config --local user.name "GitHub Actions"

      - name: Force branch to workflow SHA
        run: git reset --hard ${{ github.sha }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install
          
      - name: Python Semantic Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          poetry run semantic-release -vv version


      - name: Build package
        if: steps.release.outputs.released == 'true'
        run: |
          echo "Building package with updated version: ${{ steps.release.outputs.version }}"

          # Install dependencies
          poetry install

          # Build package
          poetry build --format wheel

      - name: Verify wheel name match release version
        if: steps.release.outputs.released == 'true'
        run: |
          echo "=== WHEEL VERIFICATION ==="
          echo "Release version: ${{ steps.release.outputs.version }}"
          echo "Release tag: ${{ steps.release.outputs.tag }}"
          echo ""
          echo "Built wheels:"
          ls -la dist/*.whl
          echo ""
          echo "Checking if wheel names contain correct version..."

      - name: Upload to GitHub Release Assets
        if: steps.release.outputs.released == 'true'
        uses: python-semantic-release/publish-action@v10.4.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.release.outputs.tag }}

      - name: Comment on PR (if applicable)
        if: steps.release.outputs.released == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Release created: ${{ steps.release.outputs.version }}\n\nTag: ${{ steps.release.outputs.tag }}\n\nYou can test this release version before merging.\n\nWheel files have been built with the correct release version.`
            })
